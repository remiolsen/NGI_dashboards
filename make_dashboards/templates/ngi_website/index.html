<!-- Generated by NGI_dashboards - https://github.com/NationalGenomicsInfrastructure/NGI_dashboards -->

<form class="form-horizontal">
    <div class="form-group">
        <label for="show_year" class="col-xs-6 col-sm-3 col-md-2 control-label">Statistics for year:</label>
        <div class="col-xs-6 col-sm-3 col-md-2">
            <select id="show_year" class="form-control"></select>
        </div>
    </div>
</form>

<style>
.delivery-time-chart {
  height: 200px;
  margin-bottom: 20px;
}
</style>

<div class="plots_content">
  <div class="row">
    <div class="col-sm-12">
      <div id="delivery_time_histograms" class="my-4">
        <div class="delivery-time-chart" id="delivery_time_sequencing_only"></div>
        <div class="delivery-time-chart" id="delivery_time_top_application_1"></div>
        <div class="delivery-time-chart" id="delivery_time_top_application_2"></div>
        <div class="delivery-time-chart" id="delivery_time_others"></div>
      </div>
    </div>
    <div class="col-sm-6">
      <div id="delivery_times_plot" class="my-4"></div>
      <div id="finished_lib_median_tat" class="my-4"></div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-6">
      <div id="num_projects_plot" class="my-4"></div>
    </div>
    <div class="col-sm-6">
      <div id="num_samples_plot" class="my-4"></div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-12">
      <div id="throughput_plot" class="my-4"></div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-12">
      <div id="affiliations_plot" class="my-4"></div>
    </div>
  </div>
</div>

<hr class="mt-5 mb-4">
<div class="dashboard-timestamps small text-muted">
  Fetched: <span id="date_rendered">{{ d.date_rendered }}</span> &nbsp;
  <em>(<span id="report_age"></span>)</em> &nbsp; / &nbsp;
  <a href="https://github.com/NationalGenomicsInfrastructure/NGI_dashboards" target="_blank">NGI Dashboards Package</a>, Version: <span>v{{ d.p_version }}</span>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script type="text/javascript">
var data = {{ d.json }};
var deliverytimes_data = {{ dt_data }};


// Javascript for the NGI Stockholm Internal Dashboard

var plot_height = 415;
jQuery(function($) {

    try {


        // Calculate how old the report is
        var updated = moment($('#date_rendered').text(), 'YYYY-MM-DD, HH:mm');
        $('#report_age').text(updated.from(moment()));

        // Check that the returned data is ok
        if ('error_status' in data){
          $('.plots_content').html('<div class="alert alert-danger text-center" style="margin: 100px 50px;"><p><strong>Apologies, there was an error whilst loading this data (API).</strong> Please try again soon.</p></div>');
          console.error(data['error_reason']);
          console.error(data['error_status']);
          console.error(data['page_title']);
          console.error(data['error_exception']);
          // Try reloading in a few minutes
          setTimeout(function(){ location.reload(); }, 60000); // 1 minute
          return false;
        }

        // Populate the years dropdown
        var get_keys = function(m) {
          var y = m.slice(0,4);
          return y;
        };
        var tmp = Object.keys(data['delivery_times']).map(get_keys);
        var years = Array.from(new Set(tmp)).sort().reverse();
        for (var i = 0; i < years.length; i++){
            $('#show_year').append('<option>'+years[i]+'</option>');
        }

        // Years dropdown changed
        $('#show_year').change(function(e){
            plot_everything( $(this).val() );
        });

        // Plot everything that's year based
        plot_everything(years[0]);

    } catch(err){
        $('.plots_content').html('<div class="alert alert-danger text-center" style="margin: 100px 50px;"><p><strong>Apologies, there was an error whilst loading this data.</strong> Please try again soon.</p></div>');
        console.error(err);
        // Try reloading in a few minutes
        setTimeout(function(){ location.reload(); }, 300000); // 5 minutes
    }

  function collect_year(data, year) {
      var months = Object.keys(data).sort().reverse();
      year_m = months.filter(function(n) {
          return n.startsWith(year)
      });
      var ydata = Object();
      for (i=0; i<year_m.length; i++) {
          var month = data[year_m[i]];
          var mkeys = Object.keys(data[year_m[i]]);
          for (j=0; j<mkeys.length; j++) {
              var mdata = data[year_m[i]][mkeys[j]];
              if (Array.isArray(mdata)) {
                  if (ydata.hasOwnProperty(mkeys[j])) {
                      tmp = ydata[mkeys[j]].concat(mdata);
                      ydata[mkeys[j]] = tmp;
                  }
                  else {
                      ydata[mkeys[j]] = mdata;
                  }
              }
              else {
                  if (ydata.hasOwnProperty(mkeys[j])) {
                      ydata[mkeys[j]] += mdata;
                  }
                  else {
                      ydata[mkeys[j]] = mdata;
                  }
              }
          }
      }
      return ydata;
  }

  function get_median(arr) {
      var median;
      arr.sort( function(a,b) {return a - b;} );
      var half = Math.floor(arr.length/2);
      if(arr.length % 2)
          median = arr[half];
      else
          median = (arr[half-1] + arr[half]) / 2.0;
      return median;
  }

  function plot_everything(year){
      try {
          // # Samples plot
          var ydata = collect_year(data['num_samples'], year);
          var ydata_seq = collect_year(data['num_seq_samples'], year);
          make_bar_chart_js('#num_samples_plot', '# Samples in '+year, 'Total: '+ (Object.values(ydata).reduce((a, b) => a + b, 0) + Object.values(ydata_seq).reduce((a, b) => a + b, 0)), {'Library prep': ydata, 'Sequencing only': ydata_seq});

          // # Projects plot
          var ydata = collect_year(data['num_projects'], year);
          var ydata_seq = collect_year(data['num_seq_projects'], year);
          var open = Object.keys(data['open_projects']).concat(Object.keys(data['open_seq_projects'])).reduce(function(obj, k) {
            obj[k] = (data['open_projects'][k] || 0) + (data['open_seq_projects'][k] || 0);
            return obj;
          }, {});
          var open_projs = Object.keys(open).map(function(a){return open[a]}).reduce(function(a,b){return a+b});
          var all_projs = Object.keys(ydata).map(function(a){return ydata[a]}).reduce(function(a,b){return a+b}) +
               Object.keys(ydata_seq).map(function(a){return ydata_seq[a]}).reduce(function(a,b){return a+b});
          var subtitle = all_projs+' since '+year+', '+open_projs+' currently open';
          make_bar_chart_js('#num_projects_plot', '# Projects in '+year, subtitle, {'Library prep': ydata, 'Sequencing only': ydata_seq, 'Ongoing': open});

          // Delivery times histograms
          make_delivery_times_histograms_chartjs(year);

          // Delivery times plot
          make_delivery_times_plot_chartjs(year);

          // Finished Library turn-around-time plot
          make_finished_lib_median_plot();

          // Affiliations plot
          make_affiliations_plot_chartjs(year);

          // Throughput plot
          make_throughput_plot_chartjs(year);
      } catch(err){
          $('.plots_content').html('<div class="alert alert-danger text-center" style="margin: 100px 50px;"><p><strong>Apologies, there was an error whilst loading this data.</strong> Please try again soon.</p></div>');
          console.error(err);
          // Try reloading in a few minutes
          setTimeout(function(){ location.reload(); }, 300000); // 5 minutes
      }

  };

  /**
   * Get histogram data out of xy data
   * @param   {Array} data  Array of tuples [x, y]
   * @param   {Number} step Resolution for the histogram
   * @returns {Array}       Histogram data
   */
  function histogram(data, step) {
      var histo = {}, x, i, arr = [], maxx = 0;

      // Group down
      for (i = 0; i < data.length; i++) {
          x = Math.floor(data[i] / step);
          if (!histo[x]) {
              histo[x] = 0;
          }
          histo[x]++;
          maxx = Math.max(x, maxx);
      }

      // Make the histo group into an array
      for (var x = 0; x <= maxx; x++){
          if (histo.hasOwnProperty((x))) {
              arr.push([parseFloat(x), histo[x]]);
          } else {
              arr.push([parseFloat(x),0]);
          }
      }

      // Finally, sort the array
      arr.sort(function (a, b) {
          return a[0] - b[0];
      });

      return arr;
  }


    function make_bar_chart_js(target, title, subtitle, seriesData){
        // Determine all categories (union of keys across series)
        var categoriesSet = {};
        var categoryTotals = {};
        Object.keys(seriesData).forEach(function(series){
            Object.keys(seriesData[series]).forEach(function(cat){
                categoriesSet[cat] = true;
                if (!categoryTotals[cat]) {
                    categoryTotals[cat] = 0;
                }
                categoryTotals[cat] += seriesData[series][cat];
            });
        });
        var categories = Object.keys(categoriesSet).sort(function(a, b) {
            return categoryTotals[b] - categoryTotals[a];
        });

        // Colors for up to three series
        var palette = ['#315a7b', '#377eb8', '#4daf4a'];

        var datasets = Object.keys(seriesData).map(function(series, idx){
            var data = categories.map(function(cat){
                return seriesData[series][cat] !== undefined ? seriesData[series][cat] : 0;
            });
            return {
                label: series,
                data: data,
                backgroundColor: palette[idx % palette.length]
            };
        });

        var $container = $(target);
        $container.empty(); // clear previous content
        var $canvas = $('<canvas></canvas>');
        $container.append($canvas);
        var ctx = $canvas[0].getContext('2d');
        // Ensure the canvas has height for vertical bars visibility
        $canvas.attr('height', plot_height);
        $container.css('height', plot_height + 'px');

        // Create annotations for category totals
        var annotations = {};
        categories.forEach(function(cat, idx){
            var total = categoryTotals[cat];
            annotations['label' + idx] = {
                type: 'label',
                yValue: cat,
                xValue: total,
                xAdjust: 14,
                backgroundColor: 'rgba(0,0,0,0)',
                color: '#333',
                content: total.toString(),
                font: {
                    size: 11,
                    weight: 'bold'
                }
            };
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: { size: 18 }
                    },
                    subtitle: {
                        display: true,
                        text: subtitle
                    },
                    legend: {
                        display: true,
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context){
                                var series = context.dataset.label || '';
                                var value = context.parsed.x;
                                return series + ': ' + value;
                            }
                        }
                    },
                    annotation: {
                        annotations: annotations
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function make_delivery_times_plot_chartjs(year){
        // Gather delivery time data
        var ydata = collect_year(data['delivery_times'], year);
        var labels = Object.keys(ydata).sort(function(a,b){
            return a.match(/\d+/) - b.match(/\d+/);
        });
        var values = labels.map(function(l){ return ydata[l]; });

        // Compute median value (in weeks)
        function computeMedian(arr){
            var sorted = arr.slice().sort(function(a,b){return a-b;});
            var half = Math.floor(sorted.length/2);
            if (sorted.length % 2)
                return sorted[half];
            return (sorted[half-1] + sorted[half]) / 2.0;
        }
        var median = computeMedian(values);

        // Calculate total for percentage calculation
        var total = values.reduce(function(a, b) { return a + b; }, 0);

        // Prepare container
        var $container = $('#delivery_times_plot');
        $container.empty(); // remove any previous content

        // Create canvas element for Chart.js
        var $canvas = $('<canvas></canvas>');
        $container.append($canvas);
        var ctx = $canvas[0].getContext('2d');
        // Ensure the canvas has height for visibility subtract space for Finished Lib TaT
        $canvas.attr('height', plot_height-200);
        $container.css('height', plot_height-200 + 'px');

        // Chart.js doughnut configuration
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#377eb8','#4daf4a','#984ea3','#ff7f00',
                        '#a65628','#f781bf','#999999','#e41a1c'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                circumference: 180,
                rotation: -90,
                plugins: {
                    title: {
                        display: true,
                        text: 'Delivery Times in ' + year,
                        font: { size: 18 }
                    },
                    legend: {
                        display: true,
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context){
                                var label = context.label || '';
                                var val = context.parsed;
                                var percentage = ((val / total) * 100).toFixed(1);
                                return label + ': ' + val + ' projects (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    function make_affiliations_plot_chartjs(year){
        var ydata = collect_year(data['project_user_affiliations'], year);
        var ykeys = Object.keys(ydata).sort(function(a,b){return ydata[a]-ydata[b]}).reverse();

        // Prepare data for Chart.js
        var labels = [];
        var values = [];
        for(i=0; i<ykeys.length; i++){
            labels.push(ykeys[i]);
            values.push(ydata[ykeys[i]]);
        }

        // Chart.js implementation
        var $container = $('#affiliations_plot');
        $container.empty(); // remove any previous content

        // Create canvas element for Chart.js
        var $canvas = $('<canvas></canvas>');
        // Ensure the canvas has uses height for visibility
        $canvas.attr('height', plot_height);
        $container.css('height', plot_height + 'px');
        $container.append($canvas);
        var ctx = $canvas[0].getContext('2d');

        // Chart.js pie configuration
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#377eb8','#4daf4a','#984ea3','#ff7f00',
                        '#a65628','#f781bf','#999999','#e41a1c'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Project Affiliations in ' + year,
                        font: { size: 18 }
                    },
                    subtitle: {
                        display: true,
                        text: 'Projects started in '+year
                    },
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            boxWidth: 10,
                            font: { size: 10 },
                            padding: 2
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.label || '';
                                var value = context.parsed;
                                return label + ': ' + value + ' projects';
                            }
                        }
                    }
                }
            }
        });
    }

    function make_throughput_plot_chartjs(year){
        var num_weeks = 52;
        var allweeks = Object.keys(data['bp_seq_per_week']).sort().reverse();
        var yearweeks = [];
        for(var i = 0; i < allweeks.length; i++){
            if(allweeks[i].substr(0,4) == year){
                yearweeks.push(allweeks[i]);
            }
        }
        var weeks = yearweeks.slice(0,num_weeks+1).reverse();
        var skeys = Array('NovaSeq 6000', 'NovaSeqXPlus', 'NextSeq 2000', 'Miseq');
        // Collect all series types
        for(i=0; i<weeks.length; i++){
            var wkeys = Object.keys(data['bp_seq_per_week'][weeks[i]]);
            for(j=0; j<wkeys.length; j++){
                if(skeys.indexOf(wkeys[j]) == -1){
                    skeys.push(wkeys[j]);
                }
            }
        }
        // Collect the data
        var sdata = Array();
        var total_count = 0;
        for(j=0; j<skeys.length; j++){
            var swdata = Array();
            var series_total = 0;
            for(i=0; i<weeks.length; i++){
                thisdata = data['bp_seq_per_week'][weeks[i]][skeys[j]];
                swdata.push(thisdata == undefined ? 0 : thisdata);
                total_count += thisdata == undefined ? 0 : thisdata;
                series_total += thisdata == undefined ? 0 : thisdata;
            }
            // Only include series with non-zero data
            if(series_total > 0){
                sdata.push({
                    name: skeys[j],
                    data: swdata
                });
            }
        }
        // Subtitle text
        var bp_per_day = total_count / (weeks.length * 7);
        var minutes_per_genome = 3236336281 / (bp_per_day / (24*60));
        var subtitle_text = 'Average for '+weeks.length+' weeks: '+parseInt(bp_per_day/1000000000)+' Gbp per day (1 Human genome equivalent every '+minutes_per_genome.toFixed(2)+' minutes)';

        // Chart.js replacement
        var labels = weeks;
        var colorPalette = [
            'rgba(49,90,123,0.6)',
            'rgba(55,126,184,0.6)',
            'rgba(77,175,122,0.6)',
            'rgba(255,127,14,0.6)',
            'rgba(166,86,40,0.6)',
            'rgba(247,129,191,0.6)',
            'rgba(152,78,163,0.6)',
            'rgba(153,153,153,0.6)',
            'rgba(228,26,28,0.6)'
        ];
        var datasets = sdata.map(function(ds, idx){
            // Divide data by 1 billion for Gbp display
            var gbpData = ds.data.map(function(val) { return val / 1000000000; });
            return {
                label: ds.name,
                data: gbpData,
                fill: true,
                backgroundColor: colorPalette[idx % colorPalette.length],
                borderColor: colorPalette[idx % colorPalette.length].replace('0.6','1'),
                borderWidth: 1,
                pointRadius: 0
            };
        });

        var $container = $('#throughput_plot');
        $container.empty();
        var $canvas = $('<canvas></canvas>');
        $container.append($canvas);
        var ctx = $canvas[0].getContext('2d');
        // Ensure the canvas has height for vertical bars visibility
        $canvas.attr('height', plot_height);
        $container.css('height', plot_height + 'px');

        if(window.throughputChart) {
            window.throughputChart.destroy();
        }
        window.throughputChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Giga base pairs'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sequencing Throughput',
                            font: { size: 18 }
                        },
                        subtitle: {
                            display: true,
                            text: subtitle_text,
                            padding: { bottom: 5 }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: 10  },
                                boxWidth: 10,
                                padding: 4
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }
        
    function make_delivery_times_histograms_chartjs(year){
        var ydata = collect_year(deliverytimes_data, year);
        var applications = Object.keys(ydata);
    
        // Sort by total count
        var totals = [];
        for(var i = 0; i < applications.length; i++){
            totals.push([applications[i], ydata[applications[i]].reduce(function(a, b) { return a + b; }, 0)]);
        }
        totals.sort(function(a, b) {
            return b[1] - a[1];
        });
        
        function median_bar(data, hist) {
            var yvals = [];
            for(idx = 0; idx < hist.length; idx++){
                yvals.push(hist[idx][1]);
            }
            data.sort( function(a,b) {return a - b;} );
            var halfval = Math.floor(data.length/2);
            var maxval = Math.max.apply(null, yvals);
            if(data.length % 2) {
                return [ data[halfval]/7, maxval ];
            } else {
                return [ ((data[halfval-1] + data[halfval]) / 2.0)/7, maxval ];
            }
        }
        
        // Get top applications
        var misc_applications = [];
        var misc_app_data = [];
        var top_total = totals.slice(0,3).sort();
        var the_rest = totals.slice(3,);
        
        // Put sequencing only first
        for(var i=0; i < top_total.length; i++) {
            if(top_total[i][0] == "Sequencing Only"){
                top_total.splice(0, 0, top_total.splice(i, 1)[0]);
            }
        }

        for (var i = 0; i < the_rest.length; i++) {
            misc_applications.push(the_rest[i][0]);
            misc_app_data = misc_app_data.concat(ydata[the_rest[i][0]]);
        }
        
        // Clean up any existing charts
        if (window.deliveryTimesCharts) {
            for (var i = 0; i < window.deliveryTimesCharts.length; i++) {
                if (window.deliveryTimesCharts[i]) {
                    window.deliveryTimesCharts[i].destroy();
                }
            }
        }
        window.deliveryTimesCharts = [];
        
        // Create charts for each application
        for(var i = 0; i < top_total.length; i++){
            var application = top_total[i][0];
            var app_data = ydata[application];
            var hist = histogram(app_data, 7);
            
            // Area chart data
            // Convert [x, y] tuples to {x, y} objects for Chart.js
            var formattedData = hist.map(function(point) {
                return {x: point[0], y: point[1]};
            });
            
            // Calculate median in weeks
            var sortedData = app_data.slice().sort(function(a,b){return a-b;});
            var median = 0;
            var n = sortedData.length;
            if (n > 0) {
                var mid = Math.floor(n/2);
                median = (n % 2 === 1) ? sortedData[mid] / 7 : (sortedData[mid-1] + sortedData[mid]) / 2 / 7;
            }
            
            // Create datasets for this application
            var colorPalette = [
                { bg: 'rgba(55, 126, 184, 0.2)', border: 'rgba(55, 126, 184, 1)' },      // blue
                { bg: 'rgba(77, 175, 74, 0.2)', border: 'rgba(77, 175, 74, 1)' },        // green
                { bg: 'rgba(152, 78, 163, 0.2)', border: 'rgba(152, 78, 163, 1)' },      // purple
                { bg: 'rgba(255, 127, 0, 0.2)', border: 'rgba(255, 127, 0, 1)' }         // orange
            ];
            var colors = colorPalette[i % colorPalette.length];
            var datasets = [];
            datasets.push({
                label: 'Frequency',
                data: formattedData,
                backgroundColor: colors.bg,
                borderColor: colors.border,
                borderWidth: 1,
                fill: true,
                pointRadius: 0
            });
            
            // Chart container setup
            var containerId = '';
            if (application === "Sequencing Only") {
                containerId = 'delivery_time_sequencing_only';
            } else if (i === 1) {
                containerId = 'delivery_time_top_application_1';
            } else {
                containerId = 'delivery_time_top_application_2';
            }
            
            var container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
                var canvas = document.createElement('canvas');
                canvas.height = 200;
                container.appendChild(canvas);
                var ctx = canvas.getContext('2d');
                
                // Create Chart.js chart
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: application + ' in ' + year
                            },
                            subtitle: {
                                display: true,
                                text: 'Median: ' + median.toFixed(1) + ' weeks'
                            },
                            legend: {
                                display: false
                            },
                            annotation: {
                                annotations: {
                                    medianLine: {
                                        type: 'line',
                                        xMin: median,
                                        xMax: median,
                                        borderColor: 'rgba(55,126,184,1)',
                                        borderWidth: 2,
                                        borderDash: [6, 6]
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Weeks'
                                },
                                beginAtZero: true,
                                max: 20,
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                display: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frequency'
                                }
                            }
                        }
                    }
                });
                
                window.deliveryTimesCharts.push(chart);
            }
        }
        
        // Create chart for miscellaneous applications if there are any
        if(misc_app_data.length > 0){
            var hist = histogram(misc_app_data, 7);
            
            // Convert [x, y] tuples to {x, y} objects for Chart.js
            var formattedData = hist.map(function(point) {
                return {x: point[0], y: point[1]};
            });
            
            // Calculate median in weeks
            var sortedData = misc_app_data.slice().sort(function(a,b){return a-b;});
            var median = 0;
            var n = sortedData.length;
            if (n > 0) {
                var mid = Math.floor(n/2);
                median = (n % 2 === 1) ? sortedData[mid] / 7 : (sortedData[mid-1] + sortedData[mid]) / 2 / 7;
            }
            
            // Create datasets for miscellaneous applications (use orange for variety)
            var datasets = [];
            datasets.push({
                label: 'Frequency',
                data: formattedData,
                backgroundColor: 'rgba(255, 127, 0, 0.2)',
                borderColor: 'rgba(255, 127, 0, 1)',
                borderWidth: 1,
                fill: true,
                pointRadius: 0,
            });
            
            // Chart container setup
            var container = document.getElementById('delivery_time_others');
            if (container) {
                container.innerHTML = '';
                var canvas = document.createElement('canvas');
                canvas.height = 200;
                container.appendChild(canvas);
                var ctx = canvas.getContext('2d');
                
                // Create Chart.js chart
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Others in ' + year
                            },
                            subtitle: {
                                display: true,
                                text: 'Median: ' + median.toFixed(1) + ' weeks'
                            },
                            legend: {
                                display: false
                            },
                            annotation: {
                                annotations: {
                                    medianLine: {
                                        type: 'line',
                                        xMin: median,
                                        xMax: median,
                                        borderColor: 'rgba(55,126,184,1)',
                                        borderWidth: 2,
                                        borderDash: [6, 6]
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Weeks'
                                },
                                beginAtZero: true,
                                max: 20,
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                display: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frequency'
                                }
                            }
                        }
                    }
                });
                
                window.deliveryTimesCharts.push(chart);
            }
        }
    }
        
        function make_finished_lib_median_plot(){
            // Compute distribution of Sequencing Only delivery times over the last 5 months
            var months = Object.keys(deliverytimes_data).sort().reverse().slice(0,5).reverse();
            var distribution = [];
            for (var idx=0; idx<months.length; idx++) {
                try {
                    var m = deliverytimes_data[months[idx]]['Sequencing Only'];
                    for (var k in m) {
                        distribution.push(m[k]);
                    }
                } catch (err) { continue; }
            }
            distribution.sort(function(a,b){return a-b;});
            var median = 0;
            var n = distribution.length;
            if (n > 0) {
                var mid = Math.floor(n/2);
                median = (n % 2 === 1) ? distribution[mid] : (distribution[mid-1] + distribution[mid]) / 2;
            }

            // Compute date label for 5 months from now
            var labelDate = moment().add(5, 'months').format('YYYY-MM');
            // Chart container setup
            var container = document.getElementById('finished_lib_median_tat');
            container.innerHTML = '';
            container.style.height = '180px';
            var canvas = document.createElement('canvas');
            canvas.height = 180;
            container.appendChild(canvas);
            var ctx = canvas.getContext('2d');
            if (window.finishedLibMedianChart) {
                window.finishedLibMedianChart.destroy();
            }

            // Create frequency data for line chart from raw distribution
            var frequencyData = {};
            distribution.forEach(function(value) {
                var key = Math.floor(value);
                frequencyData[key] = (frequencyData[key] || 0) + 1;
            });

            // Convert frequency data to chart data points
            var dataPoints = [];
            Object.keys(frequencyData).map(Number).sort(function(a,b){return a-b;}).forEach(function(key) {
                dataPoints.push({x: key, y: frequencyData[key]});
            });

            // Create a vertical line for the median
            window.finishedLibMedianChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Frequency',
                        data: dataPoints,
                        backgroundColor: 'rgba(232,100,83,0.4)',
                        borderColor: 'rgba(232,100,83,1)',
                        borderWidth: 1,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Finished Lib TaT' },
                        subtitle: {
                            display: true,
                            text: 'Median turn around for sequencing ready libraries (since ' + labelDate + '): ' + median.toFixed(1) + ' days'
                        },
                        annotation: {
                            annotations: {
                                medianLine: {
                                    type: 'line',
                                    xMin: median,
                                    xMax: median,
                                    borderColor: 'rgba(55,126,184,1)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Days' },
                            beginAtZero: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'Frequency' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    });

</script>
